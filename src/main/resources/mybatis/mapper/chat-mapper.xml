<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.web.mapper.ChatRoomMapper">
	<resultMap type="com.sist.web.vo.ChatVO" id="chatMap">
		<id property="chat_id" column="chat_id"/>
		<result property="content" column="content"/>
		<result property="dbday" column="dbday"/>
		
		<association property="cvo" javaType="com.sist.web.vo.ChatRoomVO">
			<id property="chatroom_id" column="chatroom_id"/>
			<result property="buyerId" column="buyer_id"/>
			<result property="sellerId" column="seller_id"/>
		</association>
		
		<association property="svo" javaType="com.sist.web.vo.StoreVO">
			<id property="no" column="no"/>
			<result property="storename" column="storename"/>
			<result property="image" column="image"/>
		</association>
	</resultMap>
	
	<select id="chatListData" resultMap="chatMap" parameterType="int">
		SELECT c.chat_id,c.chatroom_id,c.content,c.type,TO_CHAR(c.chat_time,'HH24:MI') as dbday,
		       cr.buyer_id,cr.seller_id,s.no,s.storename,s.image
		FROM chat_room cr JOIN chat c 
		ON c.chat_id=(SELECT MAX(c2.chat_id) FROM chat c2 WHERE c2.chatroom_id=cr.chatroom_id)
		
		JOIN store s ON s.no=
		CASE
			WHEN cr.seller_id=#{loginId}
			THEN cr.buyer_id
			ELSE cr.seller_id
		END
		
		WHERE cr.seller_id=#{loginId} OR cr.buyer_id=#{loginId}
		ORDER BY c.chat_time DESC  
	</select>
	
	<resultMap type="com.sist.web.vo.ChatRoomVO" id="tradeMap">
		<result property="tvo.name" column="name"/>
		<result property="tvo.imageurl" column="imageurl"/>
		<result property="tvo.price" column="price"/>
	</resultMap>
	
	<select id="findTradeByChatroomid" resultMap="tradeMap" parameterType="int">
		SELECT name,imageurl,price
		FROM chat_room c JOIN trade_goods t ON c.product_id=t.no
		WHERE c.chatroom_id=#{chatroomId}
	</select>
</mapper>